% Metropolis-Hastings to sample hypeparameter alpha

function [alpha Wst Cst] = sample_alpha(weights, C, alpha, phi, tau)
 

[K, N] = size(weights);
alpha_std=0.1;
nb_MH = 1; % Nb of MH iterations
for nn=1:nb_MH
    
    alpha_new = alpha*exp(alpha_std*randn);
    
    u = rand;
    logaccept = sum((-alpha+alpha_new).* log((tau+phi).*weights(end, 2:N))...
        + gammaln(alpha+C(end, :))  - gammaln(alpha_new+C(end, :))) + (-alpha+alpha_new)*log(weights(end, 1)*(phi+tau)) ;
    
    if rand<exp(logaccept) % If accept
        alpha = alpha_new;
    end
    
    
    %%%%%
    
    
    Wst = weights(end, :);
    Cst = C(end, :);
    
    wsnew = gamrnd(alpha, 1/(phi+tau));
    logaccept = - (sum(weights(:,1))+wsnew)^2 + (sum(weights(:,1))+weights(end, 1))^2 - phi*(wsnew - weights(end, 1))...
        + C(end, 1)*log(wsnew)-log(weights(end,1));
    
    if rand<exp(logaccept)
        Wst(1)  = wsnew;
    end
    
    for t=2:N
        nb_MH = 1; % Nb of MH iterations
        for nn=1:nb_MH
            csnew = poissrnd(phi.*(Wst(t-1)));
            
         
            logaccept = (-C(end, t-1)+csnew).* log((tau+phi).*weights(end, t))...
                + gammaln(alpha+C(end,t-1))  - gammaln(alpha+csnew);
            
            
            if rand<exp(logaccept)
                Cst(t-1)  = csnew;
            end
            
            % sample w_{t\ast}
            
            wsnew = gamrnd(alpha +Cst(t-1), 1/(phi+tau));
            
            logaccept = - (sum(weights(:,t))+wsnew)^2 + (sum(weights(:,t))+weights(end, t))^2 - phi*(wsnew - weights(end, t))...
                + C(end, t-1)*log(wsnew)-log(weights(end,t));
            
             if rand<exp(logaccept)
                Wst(t)  = wsnew;
            end 
            
        end
    end
    
end